# Here we
# 1. Run the create_obsop_fromexample.sh script to generate source code of an observation
#    operator from the template files in the 'example' subdirectory.
# 2. Move the generated source code to the binary directory.
# 3. Build these sources into a library (linked to ufo).
#
# If the template files get out of sync with the ufo source code, step 3 will fail,
# and hopefully someone will update the template files.
#
# Note: we don't use the example/CMakeLists.txt file, so unfortunately we won't be notified
# if that particular file gets out of date.

set(OUTPUT_FILE_NAMES
  ObsAutogenerated.cc
  ObsAutogenerated.h
  ObsAutogenerated.interface.F90
  ObsAutogenerated.interface.h
  ufo_autogenerated_mod.F90
  ObsAutogeneratedTLAD.cc
  ObsAutogeneratedTLAD.h
  ObsAutogeneratedTLAD.interface.F90
  ObsAutogeneratedTLAD.interface.h
  ufo_autogenerated_tlad_mod.F90)

set(INTERMEDIATE_OUTPUT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../../src/ufo/autogenerated")
set(FINAL_OUTPUT_DIR "${CMAKE_CURRENT_BINARY_DIR}/ufo/autogenerated")

list(TRANSFORM OUTPUT_FILE_NAMES
     PREPEND "${FINAL_OUTPUT_DIR}/"
     OUTPUT_VARIABLE OUTPUT_FILE_PATHS)

set(DEPENDENCIES
  create_obsop_fromexample.sh
  example/ObsExample.cc
  example/ObsExample.h
  example/ObsExample.interface.h
  example/ObsExample.interface.F90
  example/ufo_example_mod.F90
  example/ObsExampleTLAD.cc
  example/ObsExampleTLAD.h
  example/ObsExampleTLAD.interface.h
  example/ObsExampleTLAD.interface.F90
  example/ufo_example_tlad_mod.F90)

list(TRANSFORM DEPENDENCIES PREPEND "${CMAKE_CURRENT_SOURCE_DIR}/")

# Define a command generating the source code of an observation operator.
#
# It outputs the source code to the intermediate output directory (within the source tree),
# copies it to the final output directory (within the binary tree) and finally removes
# the intermediate output directory. We don't use CMake's rename command, since it only works
# within a single filesystem.
add_custom_command(
  OUTPUT ${OUTPUT_FILE_PATHS}
  COMMAND "${CMAKE_CURRENT_SOURCE_DIR}/create_obsop_fromexample.sh" Autogenerated autogenerated
  COMMAND "${CMAKE_COMMAND}" -E copy_directory "${INTERMEDIATE_OUTPUT_DIR}" "${FINAL_OUTPUT_DIR}"
  COMMAND "${CMAKE_COMMAND}" -E remove_directory "${INTERMEDIATE_OUTPUT_DIR}"
  DEPENDS ${DEPENDENCIES}
  VERBATIM
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})

# Build the generated source code into a library.
add_library(obsautogenerated OBJECT ${OUTPUT_FILE_PATHS})
target_link_libraries(obsautogenerated ufo)
target_include_directories(obsautogenerated PUBLIC "${CMAKE_CURRENT_BINARY_DIR}")

add_subdirectory(test)
